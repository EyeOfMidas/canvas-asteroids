<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<style type="text/css">
		html, body {
			margin: 0;
			padding: 0;
		}
		canvas {
			width: 100%;
			height: 100vh;
			display: block;
		}
	</style>
	</head>
	<body>
		<canvas id="asteroids"></canvas>
		<script src="./rAF.js"></script>
		<script src="./KeyCode.js"></script>
	<script>
		document.addEventListener("DOMContentLoaded", event => {
			init();
			animate();
		});

		window.addEventListener("resize", resize);
		window.addEventListener("keydown", onKeyDown);
		window.addEventListener("keyup", onKeyUp);

		var canvas;
		var context;
		var animId;
		var keys = [];

		var starsNear = [];
		var starsFar = [];

		var ship = {
			x: 0,
			y: 0,
			angle: 90,
			acceleration: {x: 0, y: 0},
			velocity: {x: 0, y: 0},
			width: 10,
			height: 15,
			rotationSpeed: 3,
			thrust: 0.2,
			bulletSpeed: 2,
			life: 3,
			score: 0,
		};

		var bullets = [];
		var shootDelay = 0;
		var asteroids = [];

		function init() {
			canvas = document.getElementById("asteroids");
			context = canvas.getContext('2d');

			for(let i = 0; i < 256; i++) {
				keys[i] = false;
			}

			resize();

			initStars()
			initAsteroids();
			initShip();
		}

		function resize() {
			let dpi = window.devicePixelRatio;
			canvas.width = canvas.clientWidth;
			canvas.height = canvas.clientHeight;
			context.width = canvas.clientWidth / dpi;
			context.height = canvas.clientHeight / dpi;
		}

		function animate() {
			update();
			context.save();
			context.translate(0.5, 0.5);
			clearFrame(context);
			draw(context);
			context.restore();
			animId = requestAnimationFrame(animate, canvas);
		}

		function clearFrame(context) {
			context.fillStyle = "#000000";
			context.beginPath();
			context.rect(0,0, canvas.width, canvas.height);
			context.fill();
		}

		function update() {
			updateStars();
			updateShip();
			updateBullets();
			updateCollisions();
			updateAsteroids();
		}

		function draw(context) {
			drawStars(context);
			drawShip(context);
			drawBullets(context);
			drawAsteroids(context);
			drawUI(context);
		}

		function initStars() {
			starsNear = [];
			starsFar = [];

			for(let i = 0; i < 300; i++) {
				starsNear.push({
					x: Math.floor( 2 * canvas.width * Math.random()) - canvas.width,
					y: Math.floor(2 * canvas.height * Math.random()) - canvas.height,
					size: Math.floor(2 * Math.random()) + 1,
				});
			}

			for(let i = 0; i < 300; i++) {
				starsFar.push({
					x: Math.floor(2 * canvas.width * Math.random()) - canvas.width,
					y: Math.floor(2 * canvas.height * Math.random()) - canvas.height,
					size: Math.floor(2 * Math.random()),
				});
			}
		}

		function initAsteroids() {
			asteroids = [];

			for(let i = 0; i < 2; i++) {
				createAsteroid(
					Math.floor(canvas.width * Math.random()),
					Math.floor(canvas.height * Math.random()),
					{
						x: 5 * Math.random() - 2.5,
						y: 5 * Math.random() - 2.5,
					},
					200
				);
			}
		}

		function createAsteroid(x, y, velocity, size) {
			asteroids.push({
				x: x,
				y: y,
				angle: Math.floor(360 * Math.random()),
				velocity: {
					x: velocity.x,
					y: velocity.y,
				},
				width: size,
				height: size,
				hit: false,
			});
		}

		function initShip() {
			bullets = [];
			shootDelay = 0;

			ship = {
				x: canvas.width / 2,
				y: canvas.height / 2,
				angle: 90,
				acceleration: {x: 0, y: 0},
				velocity: {x: 0, y: 0},
				width: 10,
				height: 15,
				rotationSpeed: 3,
				thrust: 0.2,
				bulletSpeed: 2,
				life: 3,
				score: 0,
			};
		}
		

		function updateStars() {
			for(let i = 0; i < 300; i++) {
				let star = starsNear[i];
				star.x += 0.2;
				star.y += 0.2;
				if(star.x > 2 * canvas.width) {
					star.x = -canvas.width;
				}
				if(star.y > 2 * canvas.width) {
					star.y = -canvas.width;
				}
			}

			for(let i = 0; i < 300; i++) {
				let star = starsFar[i];
				star.x += 0.05;
				star.y += 0.05;
				if(star.x > 2 * canvas.width) {
					star.x = -canvas.width;
				}
				if(star.y > 2 * canvas.width) {
					star.y = -canvas.width;
				}
			}
		}

		function updateShip() {
			wrapAround(ship);

			if(keys[KeyCode.A] || keys[KeyCode.Left]) { //A or left
				ship.angle += -ship.rotationSpeed;
			}
			if(keys[KeyCode.D]|| keys[KeyCode.Right]) { //D or right
				ship.angle += ship.rotationSpeed;
			}

			if(keys[KeyCode.Space]) {
				shoot();
			}

			ship.acceleration.x = 0;
			ship.acceleration.y = 0;

			if(keys[KeyCode.W] || keys[KeyCode.Up]) {//W or up
				ship.acceleration.x = ship.thrust * Math.cos(ship.angle * Math.PI / 180);
				ship.acceleration.y = ship.thrust * Math.sin(ship.angle * Math.PI / 180);
			}
			ship.angle %= 360;

			ship.velocity.x += ship.acceleration.x;
			ship.velocity.y += ship.acceleration.y;

			ship.x += ship.velocity.x;
			ship.y += ship.velocity.y;
		}

		function updateBullets() {
			shootDelay--;
			for(let i = 0; i < bullets.length; i++) {
				let bullet = bullets[i];
				bullet.x += bullet.velocity.x;
				bullet.y += bullet.velocity.y;
				if(bullet.x - 1 > canvas.width) { // too far right
					bullet.x = -1;
				} else if(bullet.x + 1 <= 0) { // too far left
					bullet.x = canvas.width + 1;
				}

				if(bullet.y - 1 > canvas.height) { // too far down
					bullet.y = -1;
				} else if(bullet.y + 1 <= 0) { // too far up
					bullet.y = canvas.height + 1;
				}

				bullet.lifespan--;
			}

			bullets = bullets.filter(bullet => bullet.lifespan > 0);
		}

		function updateCollisions() {
			for(let b = 0; b < bullets.length; b++) {
				let bullet = bullets[b];
				for(let a = 0; a < asteroids.length; a++) {
					let asteroid = asteroids[a];
					if(doesCollide(bullet, asteroid)) {
						bullet.lifespan = 0;
						asteroid.hit = true;
						ship.score += Math.floor((125 / asteroid.width) * 10);
						break;
					}
				}
			}

			for(let a = 0; a < asteroids.length; a++) {
				let asteroid = asteroids[a];
				if(doesCollide(ship, asteroid)) {
					shipDie();
					break;
				}
			}
		}

		function shipDie() {
			ship.life--;
			if(ship.life < 0) {
				cancelAnimationFrame(animId);
				alert(`Game Over! ${ship.score} points`);

				init();
				return;
			}
			let isSafeToSpawn = false;
			ship.x = Math.floor(canvas.width / 2);
			ship.y = Math.floor(canvas.height / 2);
			
			while(!isSafeToSpawn) {
				isSafeToSpawn = true;
				ship.velocity.x = 0;
				ship.velocity.y = 0;
				for(let a = 0; a < asteroids.length; a++) {
					let asteroid = asteroids[a];
					if(doesCollide(ship, asteroid)) {
						isSafeToSpawn = false;
						break;
					}
				}
				ship.x = Math.floor(canvas.width * Math.random());
				ship.y = Math.floor(canvas.height * Math.random());
			}	
		}

		function doesCollide(mobile1, mobile2) {
			let distance = Math.sqrt(
				Math.pow(mobile1.x - mobile2.x, 2) + 
				Math.pow(mobile1.y - mobile2.y, 2)
				)
			return mobile2.width / 2 >= distance - mobile1.width / 2;
		}

		function wrapAround(mobile) {
			if(mobile.x - mobile.width / 2 > canvas.width) { // too far right
			mobile.x = -mobile.width / 2;
			} else if(mobile.x + mobile.width / 2 <= 0) { // too far left
				mobile.x = canvas.width + mobile.width / 2;
			}

			if(mobile.y - mobile.height / 2 > canvas.height) { // too far down
				mobile.y = -mobile.height / 2;
			} else if(mobile.y + mobile.height / 2 <= 0) { // too far up
				mobile.y = canvas.height + mobile.height / 2;
			}
		}

		function updateAsteroids() {
			for(let i = 0; i < asteroids.length; i++) {
				let asteroid = asteroids[i];
				if(asteroid.hit) {
					asteroids.splice(i, 1);
					splitAsteroid(asteroid);
					
					if(asteroids[i]) {
						asteroid = asteroids[i];
					}
				}
				
				asteroid.x += asteroid.velocity.x;
				asteroid.y += asteroid.velocity.y;

				wrapAround(asteroid);

				asteroid.angle--;
				asteroid.angle %= 360;
			}

			if(asteroids.length == 0) {
				alert(`You win! ${ship.score} points`);
				init();
			}
		}

		function splitAsteroid(asteroid) {
			if(asteroid.width > 12.5) {
				createAsteroid(asteroid.x, asteroid.y, {
					x: asteroid.velocity.x + (2 * Math.random() - 1),
					y: asteroid.velocity.y + (2 * Math.random() - 1)
				},
				asteroid.width / 2
				);
				createAsteroid(asteroid.x, asteroid.y, {
					x: asteroid.velocity.x + (2 * Math.random() - 1),
					y: asteroid.velocity.y + (2 * Math.random() - 1)
				},
				asteroid.width / 2
				);
			}
		}

		function drawStars(context) {
			context.fillStyle = "#888888";
			for(let i = 0; i < 300; i++) {
				let star = starsNear[i];
				context.beginPath();
				context.arc(star.x, star.y, star.size, 0, 2 * Math.PI);
				context.fill();
			}

			for(let i = 0; i < 300; i++) {
				let star = starsFar[i];
				context.beginPath();
				context.arc(star.x, star.y, star.size, 0, 2 * Math.PI);
				context.fill();
			}
		}

		function drawShip(context) {
			context.fillStyle = "#448844";
			context.strokeStyle = "#44FF44";
			context.save();
			context.translate(ship.x, ship.y);
			context.rotate(ship.angle * Math.PI / 180)
			context.beginPath();
			context.moveTo(ship.height / 2, 0);
			context.lineTo(-ship.height / 2, ship.width / 2);
			context.lineTo(-ship.height / 2, -ship.width / 2);
			context.lineTo(ship.height / 2, 0);
			context.fill();
			context.stroke();

			if(keys[KeyCode.W] ||keys[KeyCode.Up]) {
				context.fillStyle = "rgba(200, 100, 100, 0.8)"
				context.beginPath();
				context.moveTo(-ship.height / 2, -ship.width / 4);
				context.lineTo(-ship.height / 2, ship.width / 4);
				context.lineTo(-1.5*ship.height, 0);
				context.lineTo(-ship.height / 2, -ship.width / 4);
				context.fill();
			}
			context.restore();
		}

		function drawBullets(context) {
			context.fillStyle = "#FFFFFF";
			for(let i = 0; i < bullets.length; i++) {
				let bullet = bullets[i];
				context.beginPath();
				context.arc(bullet.x, bullet.y, bullet.width, 0, 2 * Math.PI);
				context.fill();
			}
		}

		function drawAsteroids(context) {
			context.strokeStyle = "#BBBBBB";
			context.fillStyle = "#888888";
			for(let i = 0; i < asteroids.length; i++) {
				let asteroid = asteroids[i];
				let variance = {width: asteroid.width / 8, height: asteroid.height / 8};
				context.save();
				context.translate(asteroid.x, asteroid.y);
				context.rotate(asteroid.angle * Math.PI / 180);
				context.beginPath();
				context.moveTo(-asteroid.width / 2, -asteroid.height / 2);
				context.lineTo(-asteroid.width / 2 - variance.width, 0);
				context.lineTo(-asteroid.width / 2, asteroid.height / 2);
				context.lineTo(0, asteroid.height / 2 + variance.height);
				context.lineTo(asteroid.width / 2, asteroid.height / 2);
				context.lineTo(asteroid.width / 2 + variance.width, 0);
				context.lineTo(asteroid.width/ 2, -asteroid.height / 2);
				context.lineTo(0, -asteroid.height / 2 - variance.height);
				context.lineTo(-asteroid.width / 2, -asteroid.height / 2);
				context.fill();
				context.stroke();
				context.restore();
			}
		}

		function drawUI(context) {
			context.font = "30px Arial";
			context.textAlign = "left";
			context.fillText(`Lives: ${ship.life}`, 10, 50);
			context.textAlign = "right";
			context.fillText(`Score: ${ship.score}`, canvas.width - 10, 50);
		}

		function onKeyDown(event) {
			keys[event.keyCode] = true;
		}

		function onKeyUp(event) {
			keys[event.keyCode] = false;
			if(!keys[32]) {
				shootDelay = 0;
			}
		}

		function shoot() {
			if(shootDelay <= 0) {
				let bullet = {
					x: ship.x + (ship.height / 2) * Math.cos(ship.angle * Math.PI / 180),
					y: ship.y + (ship.height / 2) * Math.sin(ship.angle * Math.PI / 180),
					velocity: {
						x: ship.bulletSpeed * Math.cos(ship.angle * Math.PI / 180) + ship.velocity.x,
						y: ship.bulletSpeed * Math.sin(ship.angle * Math.PI / 180) + ship.velocity.y,
					},
					lifespan: 75,
					width: 2,
				};
				bullets.push(bullet);
				shootDelay = 20;
			}
		}

	</script>
	</body>
</html>